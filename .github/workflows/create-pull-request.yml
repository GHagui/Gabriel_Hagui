name: Auto Create Pull Request from develop to main

on:
  push:
    branches:
      - develop
  workflow_dispatch: # Permite execuÃ§Ã£o manual

jobs:
  create-pull-request:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Busca todo o histÃ³rico para comparar branches

      - name: Check if PR already exists
        id: check-pr
        run: |
          # Verifica se jÃ¡ existe um PR aberto de develop para main
          existing_pr=$(gh pr list --base main --head develop --state open --json number --jq '.[0].number')
          if [ -n "$existing_pr" ]; then
            echo "pr_exists=true" >> $GITHUB_OUTPUT
            echo "pr_number=$existing_pr" >> $GITHUB_OUTPUT
          else
            echo "pr_exists=false" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Pull Request
        if: steps.check-pr.outputs.pr_exists == 'false'
        run: |
          # ObtÃ©m informaÃ§Ãµes dos Ãºltimos commits
          commit_count=$(git rev-list --count main..develop)
          last_commit_msg=$(git log -1 --pretty=format:"%s" develop)

          # Cria o corpo do PR com informaÃ§Ãµes dos commits
          pr_body="## ğŸš€ Automatic Pull Request from develop to main

          Esta Ã© uma solicitaÃ§Ã£o de pull automÃ¡tica criada quando a branch \`develop\` foi atualizada.

          ### ğŸ“Š Resumo das alteraÃ§Ãµes:
          - **Commits Ã  frente de main:** $commit_count
          - **Ãšltimo commit:** $last_commit_msg

          ### ğŸ“ Commits incluÃ­dos:
          $(git log main..develop --oneline --max-count=10)

          ### âœ… Checklist:
          - [ ] CÃ³digo revisado
          - [ ] Testes passando
          - [ ] DocumentaÃ§Ã£o atualizada
          - [ ] Ready para produÃ§Ã£o

          ---
          *Este PR foi criado automaticamente pela GitHub Action*"

          # Cria o PR
          gh pr create \
            --base main \
            --head develop \
            --title "ğŸ”„ Auto-merge: develop â†’ main" \
            --body "$pr_body" \
            --label "auto-generated,merge-candidate"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update existing Pull Request
        if: steps.check-pr.outputs.pr_exists == 'true'
        run: |
          # Atualiza o PR existente com novas informaÃ§Ãµes
          commit_count=$(git rev-list --count main..develop)
          last_commit_msg=$(git log -1 --pretty=format:"%s" develop)

          pr_body="## ğŸš€ Automatic Pull Request from develop to main (Atualizado)

          Esta Ã© uma solicitaÃ§Ã£o de pull automÃ¡tica criada quando a branch \`develop\` foi atualizada.

          ### ğŸ“Š Resumo das alteraÃ§Ãµes:
          - **Commits Ã  frente de main:** $commit_count
          - **Ãšltimo commit:** $last_commit_msg
          - **Ãšltima atualizaÃ§Ã£o:** $(date)

          ### ğŸ“ Commits incluÃ­dos:
          $(git log main..develop --oneline --max-count=10)

          ### âœ… Checklist:
          - [ ] CÃ³digo revisado
          - [ ] Testes passando
          - [ ] DocumentaÃ§Ã£o atualizada
          - [ ] Ready para produÃ§Ã£o

          ---
          *Este PR foi criado automaticamente pela GitHub Action*"

          gh pr edit ${{ steps.check-pr.outputs.pr_number }} --body "$pr_body"

          echo "âœ… PR #${{ steps.check-pr.outputs.pr_number }} atualizado com sucesso!"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}