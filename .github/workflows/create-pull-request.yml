name: Auto Create Pull Request from develop to main

on:
  push:
    branches:
      - develop
  workflow_dispatch: # Permite execução manual

jobs:
  create-pull-request:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Busca todo o histórico para comparar branches

      - name: Check if PR already exists
        id: check-pr
        run: |
          # Verifica se já existe um PR aberto de develop para main
          existing_pr=$(gh pr list --base main --head develop --state open --json number --jq '.[0].number')
          if [ -n "$existing_pr" ]; then
            echo "pr_exists=true" >> $GITHUB_OUTPUT
            echo "pr_number=$existing_pr" >> $GITHUB_OUTPUT
          else
            echo "pr_exists=false" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Pull Request
        if: steps.check-pr.outputs.pr_exists == 'false'
        run: |
          # Obtém informações dos últimos commits
          commit_count=$(git rev-list --count main..develop)
          last_commit_msg=$(git log -1 --pretty=format:"%s" develop)

          # Cria o corpo do PR com informações dos commits
          pr_body="## 🚀 Automatic Pull Request from develop to main

          Esta é uma solicitação de pull automática criada quando a branch \`develop\` foi atualizada.

          ### 📊 Resumo das alterações:
          - **Commits à frente de main:** $commit_count
          - **Último commit:** $last_commit_msg

          ### 📝 Commits incluídos:
          $(git log main..develop --oneline --max-count=10)

          ### ✅ Checklist:
          - [ ] Código revisado
          - [ ] Testes passando
          - [ ] Documentação atualizada
          - [ ] Ready para produção

          ---
          *Este PR foi criado automaticamente pela GitHub Action*"

          # Cria o PR
          gh pr create \
            --base main \
            --head develop \
            --title "🔄 Auto-merge: develop → main" \
            --body "$pr_body" \
            --label "auto-generated,merge-candidate"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update existing Pull Request
        if: steps.check-pr.outputs.pr_exists == 'true'
        run: |
          # Atualiza o PR existente com novas informações
          commit_count=$(git rev-list --count main..develop)
          last_commit_msg=$(git log -1 --pretty=format:"%s" develop)

          pr_body="## 🚀 Automatic Pull Request from develop to main (Atualizado)

          Esta é uma solicitação de pull automática criada quando a branch \`develop\` foi atualizada.

          ### 📊 Resumo das alterações:
          - **Commits à frente de main:** $commit_count
          - **Último commit:** $last_commit_msg
          - **Última atualização:** $(date)

          ### 📝 Commits incluídos:
          $(git log main..develop --oneline --max-count=10)

          ### ✅ Checklist:
          - [ ] Código revisado
          - [ ] Testes passando
          - [ ] Documentação atualizada
          - [ ] Ready para produção

          ---
          *Este PR foi criado automaticamente pela GitHub Action*"

          gh pr edit ${{ steps.check-pr.outputs.pr_number }} --body "$pr_body"

          echo "✅ PR #${{ steps.check-pr.outputs.pr_number }} atualizado com sucesso!"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}