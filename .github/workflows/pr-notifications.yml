name: PR Status Notifications

on:
  pull_request:
    types: [opened, closed, synchronized]
    branches:
      - main
  pull_request_review:
    types: [submitted]

jobs:
  notify-pr-status:
    runs-on: ubuntu-latest
    if: github.head_ref == 'develop' && github.base_ref == 'main'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: PR Opened Notification
        if: github.event.action == 'opened'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.number }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
          PR_URL: ${{ github.event.pull_request.html_url }}
        run: |
          echo "🎉 Novo PR criado: develop → main"
          echo "📋 PR #${PR_NUMBER}: ${PR_TITLE}"
          echo "👤 Criado por: @${PR_AUTHOR}"
          echo "🔗 URL: ${PR_URL}"

          # Adicionar comentário automático com instruções (usando vars seguras)
          gh pr comment "${PR_NUMBER}" --body "## 🤖 Auto-generated comment

          ### 📋 Checklist de merge:
          - [ ] Code review completo
          - [ ] Todos os testes passando
          - [ ] Documentação atualizada
          - [ ] Aprovação de pelo menos 1 reviewer

          ### 🚀 Para fazer merge:
          1. Certifique-se que todos os checks estão passando
          2. Obtenha aprovação dos reviewers necessários
          3. Use **Squash and merge** ou **Merge commit** conforme preferência do projeto

          *Este comentário foi gerado automaticamente*"

      - name: PR Updated Notification
        if: github.event.action == 'synchronize'
        env:
          PR_NUMBER: ${{ github.event.number }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_SENDER: ${{ github.event.sender.login }}
        run: |
          echo "🔄 PR atualizado: develop → main"
          echo "📋 PR #${PR_NUMBER}: ${PR_TITLE}"
          echo "👤 Atualizado por: @${PR_SENDER}"

      - name: PR Merged Notification
        if: github.event.action == 'closed' && github.event.pull_request.merged == true
        env:
          PR_NUMBER: ${{ github.event.number }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_MERGED_BY: ${{ github.event.pull_request.merged_by.login }}
        run: |
          echo "✅ PR merged com sucesso!"
          echo "📋 PR #${PR_NUMBER}: ${PR_TITLE}"
          echo "👤 Merged por: @${PR_MERGED_BY}"

          # Opcional: criar tag de release
          echo "🏷️ Considerando criar uma tag de release..."

      - name: PR Closed Without Merge
        if: github.event.action == 'closed' && github.event.pull_request.merged == false
        env:
          PR_NUMBER: ${{ github.event.number }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_SENDER: ${{ github.event.sender.login }}
        run: |
          echo "❌ PR fechado sem merge"
          echo "📋 PR #${PR_NUMBER}: ${PR_TITLE}"
          echo "👤 Fechado por: @${PR_SENDER}"

      - name: Review Submitted
        if: github.event_name == 'pull_request_review'
        env:
          REVIEWER: ${{ github.event.review.user.login }}
          REVIEW_STATE: ${{ github.event.review.state }}
        run: |
          echo "📝 Review submetido por @${REVIEWER}"
          echo "🎯 Estado: ${REVIEW_STATE}"
          if [ "${REVIEW_STATE}" = "approved" ]; then
            echo "✅ PR aprovado!"
          elif [ "${REVIEW_STATE}" = "changes_requested" ]; then
            echo "⚠️ Mudanças solicitadas"
          fi
