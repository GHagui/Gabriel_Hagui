name: PR Status Notifications

on:
  pull_request:
    types: [opened, closed, synchronized]
    branches:
      - main
  pull_request_review:
    types: [submitted]

jobs:
  notify-pr-status:
    runs-on: ubuntu-latest
    if: github.head_ref == 'develop' && github.base_ref == 'main'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: PR Opened Notification
        if: github.event.action == 'opened'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.number }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
          PR_URL: ${{ github.event.pull_request.html_url }}
        run: |
          echo "ğŸ‰ Novo PR criado: develop â†’ main"
          echo "ğŸ“‹ PR #${PR_NUMBER}: ${PR_TITLE}"
          echo "ğŸ‘¤ Criado por: @${PR_AUTHOR}"
          echo "ğŸ”— URL: ${PR_URL}"

          # Adicionar comentÃ¡rio automÃ¡tico com instruÃ§Ãµes (usando vars seguras)
          gh pr comment "${PR_NUMBER}" --body "## ğŸ¤– Auto-generated comment

          ### ğŸ“‹ Checklist de merge:
          - [ ] Code review completo
          - [ ] Todos os testes passando
          - [ ] DocumentaÃ§Ã£o atualizada
          - [ ] AprovaÃ§Ã£o de pelo menos 1 reviewer

          ### ğŸš€ Para fazer merge:
          1. Certifique-se que todos os checks estÃ£o passando
          2. Obtenha aprovaÃ§Ã£o dos reviewers necessÃ¡rios
          3. Use **Squash and merge** ou **Merge commit** conforme preferÃªncia do projeto

          *Este comentÃ¡rio foi gerado automaticamente*"

      - name: PR Updated Notification
        if: github.event.action == 'synchronize'
        env:
          PR_NUMBER: ${{ github.event.number }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_SENDER: ${{ github.event.sender.login }}
        run: |
          echo "ğŸ”„ PR atualizado: develop â†’ main"
          echo "ğŸ“‹ PR #${PR_NUMBER}: ${PR_TITLE}"
          echo "ğŸ‘¤ Atualizado por: @${PR_SENDER}"

      - name: PR Merged Notification
        if: github.event.action == 'closed' && github.event.pull_request.merged == true
        env:
          PR_NUMBER: ${{ github.event.number }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_MERGED_BY: ${{ github.event.pull_request.merged_by.login }}
        run: |
          echo "âœ… PR merged com sucesso!"
          echo "ğŸ“‹ PR #${PR_NUMBER}: ${PR_TITLE}"
          echo "ğŸ‘¤ Merged por: @${PR_MERGED_BY}"

          # Opcional: criar tag de release
          echo "ğŸ·ï¸ Considerando criar uma tag de release..."

      - name: PR Closed Without Merge
        if: github.event.action == 'closed' && github.event.pull_request.merged == false
        env:
          PR_NUMBER: ${{ github.event.number }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_SENDER: ${{ github.event.sender.login }}
        run: |
          echo "âŒ PR fechado sem merge"
          echo "ğŸ“‹ PR #${PR_NUMBER}: ${PR_TITLE}"
          echo "ğŸ‘¤ Fechado por: @${PR_SENDER}"

      - name: Review Submitted
        if: github.event_name == 'pull_request_review'
        env:
          REVIEWER: ${{ github.event.review.user.login }}
          REVIEW_STATE: ${{ github.event.review.state }}
        run: |
          echo "ğŸ“ Review submetido por @${REVIEWER}"
          echo "ğŸ¯ Estado: ${REVIEW_STATE}"
          if [ "${REVIEW_STATE}" = "approved" ]; then
            echo "âœ… PR aprovado!"
          elif [ "${REVIEW_STATE}" = "changes_requested" ]; then
            echo "âš ï¸ MudanÃ§as solicitadas"
          fi
